output: default
groups:
  OKWSME:
    name: Aggregate per_*_thruput to metrics
    description: use lookup to assign group name, then aggregate by that group
    disabled: false
    index: 3
  RF1qBS:
    name: Aggregate thruput to metrics
    description: use lookup to assign group name, then aggregate by that group
    index: 4
    disabled: false
asyncFuncTimeout: 1000
functions:
  - id: comment
    filter: "true"
    disabled: null
    conf:
      comment: Drop all metrics that are not thruput related
  - id: drop
    filter: "! (/group=per_/.test(_raw) || /group=thruput, name=thruput/.test(_raw))"
    disabled: null
    conf: {}
    final: true
  - id: comment
    filter: "true"
    disabled: null
    conf:
      comment: "[optional] Aggregate by farm into metrics index"
  - id: comment
    filter: "true"
    disabled: false
    conf:
      comment: Pull the stats into stats
    groupId: OKWSME
  - id: serde
    filter: /group=per_/.test(_raw)
    disabled: false
    conf:
      mode: extract
      type: kvp
      srcField: _raw
      cleanFields: false
      dstField: stats
    groupId: OKWSME
  - id: comment
    filter: "true"
    disabled: false
    conf:
      comment: Lookup host mapping
    groupId: OKWSME
  - id: lookup
    filter: stats.group.startsWith('per_')
    disabled: false
    conf:
      matchMode: regex
      matchType: first
      reloadPeriodSec: 60
      addToEvent: false
      inFields:
        - eventField: host
          lookupField: host
      ignoreCase: false
      file: host_mapping.csv
      outFields:
        - lookupField: grouping
          eventField: farm
    groupId: OKWSME
    description: Lookup farm (pod, env, whatever) for aggregations
  - id: eval
    filter: farm
    disabled: false
    conf:
      add:
        - name: stats.series
          value: "stats.series == host ? farm : stats.series"
    groupId: OKWSME
  - id: aggregation
    filter: farm
    disabled: false
    conf:
      passthrough: false
      preserveGroupBys: false
      sufficientStatsOnly: false
      metricsMode: true
      timeWindow: 30s
      aggregations:
        - avg(stats.avg_age).as('avg_age')
        - max(stats.avg_age).as('max_avg_age')
        - sum(stats.ev).as('ev')
        - sum(stats.kb).as('kb')
        - max(stats.max_age).as('max_age')
      cumulative: false
      groupbys:
        - host
        - stats.group
        - stats.series
      add:
        - name: index
          value: "'metrics'"
        - name: source
          value: "'metrics:aggs'"
        - name: sourcetype
          value: "'metrics:aggs'"
    groupId: OKWSME
    final: false
  - id: comment
    filter: "true"
    disabled: false
    conf:
      comment: Pull the stats into stats
    groupId: RF1qBS
  - id: serde
    filter: /group=thruput/.test(_raw)
    disabled: false
    conf:
      mode: extract
      type: kvp
      srcField: _raw
      cleanFields: false
      dstField: stats
    groupId: RF1qBS
  - id: comment
    filter: "true"
    disabled: false
    conf:
      comment: Lookup host mapping
    groupId: RF1qBS
  - id: lookup
    filter: stats.name == 'thruput'
    disabled: false
    conf:
      matchMode: regex
      matchType: first
      reloadPeriodSec: 60
      addToEvent: false
      inFields:
        - eventField: host
          lookupField: host
      ignoreCase: false
      file: host_mapping.csv
      outFields:
        - lookupField: grouping
          eventField: farm
    groupId: RF1qBS
    description: Lookup farm (pod, env, whatever) for aggregations
  - id: aggregation
    filter: farm
    disabled: false
    conf:
      passthrough: false
      preserveGroupBys: false
      sufficientStatsOnly: false
      metricsMode: true
      timeWindow: 30s
      aggregations:
        - sum(stats.kb).as('kb')
        - sum(stats.ev).as('ev')
        - avg(stats.load_average).as('load_avg')
      cumulative: false
      groupbys:
        - farm
      add:
        - name: index
          value: "'metrics'"
        - name: source
          value: "'metrics:aggs'"
        - name: sourcetype
          value: "'metrics:aggs'"
    groupId: RF1qBS
    final: false
  - id: comment
    filter: "true"
    disabled: null
    conf:
      comment: "[optional] Trim timestamp from _raw logs (only runs if aggregations
        aren't enabled)"
  - id: mask
    filter: "! __criblMetrics"
    disabled: false
    conf:
      rules:
        - matchRegex: /^.*group=/
          replaceExpr: "'group='"
      fields:
        - _raw
  - id: comment
    filter: "true"
    disabled: null
    conf:
      comment: "[optional] Trim source to just filename"
  - id: mask
    filter: "! __criblMetrics"
    disabled: false
    conf:
      rules:
        - matchRegex: /.*[\\/]/
          replaceExpr: "'./'"
      fields:
        - source
